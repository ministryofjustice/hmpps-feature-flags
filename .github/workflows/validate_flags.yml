name: Validate Flags

on:
  push:
    paths:
      - "flags/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flipt CLI
        uses: flipt-io/setup-action@v0.5.0
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          version: v2
      - name: Validate flags
        shell: bash
        run: |
          set -euo pipefail
          validate_directory() {
            local dir="$1"
            if find "$dir" -maxdepth 1 -type f \( -name 'features.yaml' -o -name 'features.yml' -o -name '*.features.yaml' -o -name '*.features.yml' \) | grep -q .; then
              flipt validate --work-dir "$dir"
            else
              echo "No Flipt feature files found in $dir, skipping."
            fi
          }

          validate_directory flags/dev
          validate_directory flags/preprod
          validate_directory flags/prod
